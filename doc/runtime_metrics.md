# runtime metrics

go1.16新加了runtime/metrics包，用于收集系统运行中的性能指标信息。

指标的信息如下：

```json
[
    {
        "Name":"/gc/cycles/automatic:gc-cycles",
        "Description":"Count of completed GC cycles generated by the Go runtime.",
        "Kind":1,
        "Cumulative":true
    },
    {
        "Name":"/gc/cycles/forced:gc-cycles",
        "Description":"Count of completed GC cycles forced by the application.",
        "Kind":1,
        "Cumulative":true
    },
    {
        "Name":"/gc/cycles/total:gc-cycles",
        "Description":"Count of all completed GC cycles.",
        "Kind":1,
        "Cumulative":true
    },
    {
        "Name":"/gc/heap/allocs-by-size:bytes",
        "Description":"Distribution of all objects allocated by approximate size.",
        "Kind":3,
        "Cumulative":true
    },
    {
        "Name":"/gc/heap/frees-by-size:bytes",
        "Description":"Distribution of all objects freed by approximate size.",
        "Kind":3,
        "Cumulative":true
    },
    {
        "Name":"/gc/heap/goal:bytes",
        "Description":"Heap size target for the end of the GC cycle.",
        "Kind":1,
        "Cumulative":false
    },
    {
        "Name":"/gc/heap/objects:objects",
        "Description":"Number of objects, live or unswept, occupying heap memory.",
        "Kind":1,
        "Cumulative":false
    },
    {
        "Name":"/gc/pauses:seconds",
        "Description":"Distribution individual GC-related stop-the-world pause latencies.",
        "Kind":3,
        "Cumulative":true
    },
    {
        "Name":"/memory/classes/heap/free:bytes",
        "Description":"Memory that is completely free and eligible to be returned to the underlying system, but has not been. This metric is the runtime's estimate of free address space that is backed by physical memory.",
        "Kind":1,
        "Cumulative":false
    },
    {
        "Name":"/memory/classes/heap/objects:bytes",
        "Description":"Memory occupied by live objects and dead objects that have not yet been marked free by the garbage collector.",
        "Kind":1,
        "Cumulative":false
    },
    {
        "Name":"/memory/classes/heap/released:bytes",
        "Description":"Memory that is completely free and has been returned to the underlying system. This metric is the runtime's estimate of free address space that is still mapped into the process, but is not backed by physical memory.",
        "Kind":1,
        "Cumulative":false
    },
    {
        "Name":"/memory/classes/heap/stacks:bytes",
        "Description":"Memory allocated from the heap that is reserved for stack space, whether or not it is currently in-use.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/heap/unused:bytes",
        "Description":"Memory that is reserved for heap objects but is not currently used to hold heap objects.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/metadata/mcache/free:bytes",
        "Description":"Memory that is reserved for runtime mcache structures, but not in-use.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/metadata/mcache/inuse:bytes",
        "Description":"Memory that is occupied by runtime mcache structures that are currently being used.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/metadata/mspan/free:bytes",
        "Description":"Memory that is reserved for runtime mspan structures, but not in-use.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/metadata/mspan/inuse:bytes",
        "Description":"Memory that is occupied by runtime mspan structures that are currently being used.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/metadata/other:bytes",
        "Description":"Memory that is reserved for or used to hold runtime metadata.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/os-stacks:bytes",
        "Description":"Stack memory allocated by the underlying operating system.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/other:bytes",
        "Description":"Memory used by execution trace buffers, structures for debugging the runtime, finalizer and profiler specials, and more.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/profiling/buckets:bytes",
        "Description":"Memory that is used by the stack trace hash map used for profiling.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/memory/classes/total:bytes",
        "Description":"All memory mapped by the Go runtime into the current process as read-write. Note that this does not include memory mapped by code called via cgo or via the syscall package. Sum of all metrics in /memory/classes.",
        "Kind":1,
        "Cumulative":false
    },{
        "Name":"/sched/goroutines:goroutines",
        "Description":"Count of live goroutines.",
        "Kind":1,
        "Cumulative":false
    }]
```

[对应结构](https://pkg.go.dev/runtime/metrics#Description)：

```go
type Description struct {
	// Name is the full name of the metric which includes the unit.
	//
	// The format of the metric may be described by the following regular expression.
	//
	// 	^(?P<name>/[^:]+):(?P<unit>[^:*/]+(?:[*/][^:*/]+)*)$
	//
	// The format splits the name into two components, separated by a colon: a path which always
	// starts with a /, and a machine-parseable unit. The name may contain any valid Unicode
	// codepoint in between / characters, but by convention will try to stick to lowercase
	// characters and hyphens. An example of such a path might be "/memory/heap/free".
	//
	// The unit is by convention a series of lowercase English unit names (singular or plural)
	// without prefixes delimited by '*' or '/'. The unit names may contain any valid Unicode
	// codepoint that is not a delimiter.
	// Examples of units might be "seconds", "bytes", "bytes/second", "cpu-seconds",
	// "byte*cpu-seconds", and "bytes/second/second".
	//
	// For histograms, multiple units may apply. For instance, the units of the buckets and
	// the count. By convention, for histograms, the units of the count are always "samples"
	// with the type of sample evident by the metric's name, while the unit in the name
	// specifies the buckets' unit.
	//
	// A complete name might look like "/memory/heap/free:bytes".
	Name string

	// Description is an English language sentence describing the metric.
	Description string

	// Kind is the kind of value for this metric.
	//
	// The purpose of this field is to allow users to filter out metrics whose values are
	// types which their application may not understand.
	Kind ValueKind

	// Cumulative is whether or not the metric is cumulative. If a cumulative metric is just
	// a single number, then it increases monotonically. If the metric is a distribution,
	// then each bucket count increases monotonically.
	//
	// This flag thus indicates whether or not it's useful to compute a rate from this value.
	Cumulative bool
}
```

其中Kind字段取值有：1 uint64;2 float64;3 *Float64Histogram;

两次样本的信息如下：

```txt
time: 2021-02-25 17:36:56.895318216 +0800 CST m=+10.010772885
KindUint64 /gc/cycles/automatic:gc-cycles: 0
KindUint64 /gc/cycles/forced:gc-cycles: 0
KindUint64 /gc/cycles/total:gc-cycles: 0
KindFloat64Histogram /gc/heap/allocs-by-size:bytes: 25.000000
KindFloat64Histogram /gc/heap/frees-by-size:bytes: 1.000000
KindUint64 /gc/heap/goal:bytes: 4473924
KindUint64 /gc/heap/objects:objects: 25115
KindFloat64Histogram /gc/pauses:seconds: -Inf
KindUint64 /memory/classes/heap/free:bytes: 0
KindUint64 /memory/classes/heap/objects:bytes: 3731736
KindUint64 /memory/classes/heap/released:bytes: 62652416
KindUint64 /memory/classes/heap/stacks:bytes: 688128
KindUint64 /memory/classes/heap/unused:bytes: 36584
KindUint64 /memory/classes/metadata/mcache/free:bytes: 13984
KindUint64 /memory/classes/metadata/mcache/inuse:bytes: 2400
KindUint64 /memory/classes/metadata/mspan/free:bytes: 10320
KindUint64 /memory/classes/metadata/mspan/inuse:bytes: 55216
KindUint64 /memory/classes/metadata/other:bytes: 3672248
KindUint64 /memory/classes/os-stacks:bytes: 0
KindUint64 /memory/classes/other:bytes: 520184
KindUint64 /memory/classes/profiling/buckets:bytes: 1444952
KindUint64 /memory/classes/total:bytes: 72828168
KindUint64 /sched/goroutines:goroutines: 31


time: 2021-02-25 17:37:01.895616653 +0800 CST m=+15.011071320
KindUint64 /gc/cycles/automatic:gc-cycles: 0
KindUint64 /gc/cycles/forced:gc-cycles: 0
KindUint64 /gc/cycles/total:gc-cycles: 0
KindFloat64Histogram /gc/heap/allocs-by-size:bytes: 25.000000
KindFloat64Histogram /gc/heap/frees-by-size:bytes: 1.000000
KindUint64 /gc/heap/goal:bytes: 4473924
KindUint64 /gc/heap/objects:objects: 25737
KindFloat64Histogram /gc/pauses:seconds: -Inf
KindUint64 /memory/classes/heap/free:bytes: 0
KindUint64 /memory/classes/heap/objects:bytes: 3829720
KindUint64 /memory/classes/heap/released:bytes: 62554112
KindUint64 /memory/classes/heap/stacks:bytes: 688128
KindUint64 /memory/classes/heap/unused:bytes: 36904
KindUint64 /memory/classes/metadata/mcache/free:bytes: 13984
KindUint64 /memory/classes/metadata/mcache/inuse:bytes: 2400
KindUint64 /memory/classes/metadata/mspan/free:bytes: 10320
KindUint64 /memory/classes/metadata/mspan/inuse:bytes: 55216
KindUint64 /memory/classes/metadata/other:bytes: 3684584
KindUint64 /memory/classes/os-stacks:bytes: 0
KindUint64 /memory/classes/other:bytes: 769992
KindUint64 /memory/classes/profiling/buckets:bytes: 1444952
KindUint64 /memory/classes/total:bytes: 73090312
KindUint64 /sched/goroutines:goroutines: 31
```
